CWE_917_RULE = """
[CWE-917 Reference Guideline | Improper Neutralization of Special Elements used in an Expression Language Statement ('Expression Language Injection') | Non-binding, Evidence-first]

Overview
- CWE-917 occurs when the product constructs all or part of an expression language (EL) statement in a framework such as a Java Server Page (JSP) using externally-influenced input from an upstream component.
- If the input is not properly neutralized or incorrectly neutralized, special elements such as `${}` can be injected into the EL statement, potentially modifying the intended behavior of the statement and allowing an attacker to execute arbitrary code or access unauthorized data.
- In partial snippets, missing or incorrectly sanitized input handling is not proof of vulnerability. Use this guideline to form hypotheses and identify code evidence that would confirm or refute them.

What counts as "Expression Language Injection" and "neutralization" (static analysis framing)
- Expression Language (EL) Injection:
  - Occurs when untrusted input is embedded directly into an EL statement without proper sanitization or validation, leading to the potential for attackers to inject malicious expressions.
  - These injections can modify the behavior of EL statements, allowing attackers to access sensitive data, execute arbitrary code, or bypass security controls.
- Improper Neutralization:
  - Failing to properly sanitize or escape user input when it is incorporated into an EL statement, allowing special characters (e.g., `${}`) to be interpreted as part of the EL expression rather than user input.
  - This may allow attackers to inject arbitrary expressions into the EL, leading to unintended behavior or security risks.

Where EL injection issues typically occur (sensitive sinks)
- User input used in EL statements:
  - Constructing EL statements dynamically by incorporating user-provided data (e.g., using `${}` or similar syntax) without ensuring that the data is sanitized.
- Web application frameworks:
  - Java Server Pages (JSP), Facelets, or other templating engines that allow embedding EL expressions in HTML, where improper handling of user input can lead to EL injection.
- Data passed to the view:
  - Data passed from the server to the client via templates or JSPs that are later used in EL expressions without adequate sanitization.

Common failure modes (reasoning hints, not assumptions)
- No input sanitization:
  - User input is directly inserted into an EL expression without checking or neutralizing special characters that could alter the expression's logic.
- Improper escaping of special characters:
  - The `${}` syntax or other EL-related characters are not properly escaped or sanitized, allowing attackers to inject arbitrary EL expressions.
- Misconfigured or insecure EL expression handling:
  - EL expressions are evaluated or executed without proper checks for input validity, allowing attackers to manipulate the logic or access unauthorized data.
- Insecure use of EL with dynamic data:
  - EL is used dynamically with external input data without adequate validation, leading to a potential attack vector for injecting malicious code.

What “secure EL statement handling” looks like (context-specific)
- Proper input sanitization:
  - Sanitize or validate user input before embedding it into EL expressions to ensure that special characters like `${}`, `#`, or `}` are not interpreted as part of the EL expression.
- Use of secure frameworks and libraries:
  - Employ frameworks or libraries that automatically handle EL injection prevention by escaping or filtering input to ensure that it cannot interfere with the EL syntax.
- Explicitly escape special characters:
  - Ensure that any special characters used in EL expressions (such as `${}`, `#{}`, etc.) are properly escaped or removed before being included in the EL statement.
- Least privilege principle:
  - Limit the scope of the EL expression execution, ensuring that user input is only used in contexts where its impact is minimized (e.g., restrict access to sensitive data or actions through EL expressions).
- Input validation before binding:
  - Validate and verify that user-supplied data matches expected formats or ranges before binding it to an EL expression.

Common weak/insufficient defenses (signals of possible risk)
- Direct injection of user input into EL expressions:
  - User input is inserted directly into an EL statement without checks, allowing an attacker to inject arbitrary expressions or code.
- No input validation or escaping:
  - Special characters, such as `${}` or `#`, are not sanitized before being embedded in EL expressions, allowing attackers to manipulate the execution.
- Insecure frameworks or libraries:
  - Using templating engines or frameworks that do not provide automatic protection against EL injection or fail to properly handle user input.
- Over-permissive expression handling:
  - EL expressions that are evaluated or executed without proper restrictions or validations, making it possible for attackers to access sensitive data or execute unintended operations.

Evidence to look for in code (static snippet oriented)
- Strong evidence of mitigation:
  - Input sanitization is explicitly performed before embedding user data in an EL expression (e.g., using `StringEscapeUtils.escapeXml()` or similar mechanisms).
  - Proper escaping of special characters is implemented to ensure that user input is treated as data and not interpreted as part of the EL syntax.
  - The use of secure frameworks or libraries that automatically escape or sanitize user input in EL expressions.
  - Access to sensitive data or resources is restricted through role-based access control (RBAC) or other mechanisms to limit the impact of any potential EL injection.
- Evidence suggesting vulnerability:
  - User input is directly inserted into an EL statement (e.g., `${userInput}`) without proper sanitization or escaping.
  - Special characters like `${}`, `#`, or `}` are not validated or escaped before being used in EL expressions.
  - EL expressions are dynamically generated without proper input validation or filtering, allowing untrusted input to influence the evaluation.
  - No security mechanisms or checks are applied before executing EL expressions, leading to possible data leakage or arbitrary code execution.

How to use this guideline under incomplete context
- Identify where EL expressions are used:
  - Look for places where user input is incorporated into EL expressions (e.g., `${userInput}` or `#{userData}`) and examine how input is sanitized or validated.
- Identify the sanitization or escaping mechanisms in place:
  - Are there explicit checks or filters to ensure that special characters are properly handled before being inserted into EL expressions?
- Generate a small number of targeted hypotheses:
  - H1: User input is directly inserted into EL expressions without proper validation or escaping, leading to injection risks.
  - H2: There is no proper input sanitization or escaping in the system, making it vulnerable to Expression Language Injection.
  - H3: The application relies on an insecure framework that does not provide automatic protection against EL injection.
  - H4: User input is being processed dynamically in a way that allows for unsafe evaluation of EL expressions.
- For each hypothesis, specify:
  (a) evidence in the snippet supporting it (e.g., direct input insertion, missing escaping),
  (b) evidence needed to confirm it (e.g., secure libraries, explicit sanitization or escaping),
  (c) counter-evidence that would refute it (e.g., secure handling of EL input, automatic protections from the framework).

Quick red flags in partial code (weak → strong)
- Strong: User input is inserted directly into an EL expression without any form of sanitization or escaping, making the application vulnerable to injection.
- Medium: EL expressions use user input but lack proper escaping or validation, leaving the application vulnerable to attacks.
- Medium: Input handling is absent or weak, and sensitive operations or data are processed through dynamic EL without restrictions.
- Weak: EL handling may be managed by external frameworks or libraries not visible in the snippet → treat as Unknown and reduce confidence.
"""
if __name__ == "__main__":
    print(CWE_917_RULE)
