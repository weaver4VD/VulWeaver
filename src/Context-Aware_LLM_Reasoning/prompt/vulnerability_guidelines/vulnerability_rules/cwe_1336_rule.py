CWE_1336_RULE = """
[CWE-1336 Reference Guideline | Improper Neutralization of Special Elements Used in a Template Engine | Non-binding, Evidence-first]

Overview
- CWE-1336 occurs when the product uses a template engine to insert or process externally-influenced input, but it does not neutralize or incorrectly neutralizes special elements or syntax that can be interpreted as template expressions or other code directives when processed by the engine.
- This can lead to security vulnerabilities such as code injection, data leakage, or unauthorized execution of code within the template engine. An attacker may inject malicious code or control flow that gets executed as part of the template rendering process, leading to potential security breaches.
- In partial snippets, improper handling of template inputs is not proof of vulnerability. Use this guideline to form hypotheses and identify code evidence that would confirm or refute them.

What counts as "template engine" and "special elements" (static analysis framing)
- Template Engine:
  - A software component that processes templates to generate dynamic content by merging static template files with dynamic data (e.g., user input, data from a database).
  - Common template engines include Thymeleaf, Velocity, JSP, and Mustache, which allow the embedding of dynamic expressions or logic into static templates.
- Special Elements or Syntax:
  - Characters or constructs that are interpreted by the template engine as part of its execution logic (e.g., `${}`, `{{ }}`, or `<% %>`).
  - These elements may allow the insertion of variables, code logic, or control structures that could be exploited if improperly handled, leading to template injection or code execution vulnerabilities.

Where improper neutralization issues typically occur (sensitive sinks)
- Template input processing:
  - Processing user input in a template without properly neutralizing special characters or syntax that could be interpreted as part of the template engine’s expressions (e.g., `${userInput}`, `{{maliciousInput}}`).
- Dynamic content generation:
  - When user-provided data or external input is injected into templates without validation or escaping, leading to the risk of code injection within the rendered output.
- Execution of injected code:
  - Improperly handled or unsanitized input in templates can allow attackers to inject code that gets executed by the template engine during the rendering phase (e.g., executing arbitrary code or logic within the template).

Common failure modes (reasoning hints, not assumptions)
- Lack of input sanitization:
  - The application fails to sanitize or escape special characters before injecting external input into the template, allowing those inputs to be interpreted as part of the template expression.
- Incorrectly handled template syntax:
  - Input containing template-specific syntax (e.g., `${}` or `{{}}`) is not properly neutralized, and the template engine executes the input as a directive or expression.
- Over-permissive template parsing:
  - The template engine allows unsafe expressions or logic to be evaluated without proper restrictions or sanitization, enabling the execution of arbitrary code.
- Inconsistent escaping or filtering:
  - Special elements or template syntax are inconsistently escaped or filtered, leaving some parts of the input vulnerable to injection while others are protected.

What “secure template input handling” looks like (context-specific)
- Proper escaping of template syntax:
  - Ensure that user input is properly escaped before being included in a template, ensuring that special elements (e.g., `${}`, `{{}}`, `<% %>`) are treated as plain data rather than part of the template expression.
- Input validation:
  - Validate user input to ensure that it does not contain dangerous or untrusted characters (e.g., disallowing characters like `${}`, `{{}}`, `<% %>`, or any other template-specific syntax in user input).
- Use of a secure template engine:
  - Use template engines that provide built-in protections against injection vulnerabilities, such as automatically escaping variables or data before rendering it into the template.
- Explicit content filtering:
  - Apply content filtering to disallow potentially dangerous input in contexts where special elements or template syntax may be interpreted.
- Enforced least privilege:
  - Restrict what template engines can do with input data, ensuring that sensitive operations or logic cannot be executed via injected code.

Common weak/insufficient defenses (signals of possible risk)
- No escaping or neutralization of special characters:
  - Special characters or syntax (e.g., `${}`, `{{}}`, `<% %>`) are directly injected into the template without escaping, allowing them to be interpreted as template expressions.
- Improper input filtering:
  - User input is inserted into templates without being properly filtered for unsafe elements or constructs, making it vulnerable to injection attacks.
- Template engine allows dynamic code execution:
  - The template engine is configured to allow dynamic code execution (e.g., evaluating expressions, running scripts) without sufficient restrictions, enabling attackers to inject arbitrary code.
- Inconsistent sanitization across templates:
  - Different templates or rendering functions apply different levels of input sanitization, allowing some templates to be vulnerable while others are safe.

Evidence to look for in code (static snippet oriented)
- Strong evidence of mitigation:
  - Regular expression or escaping functions that ensure input is sanitized before being included in template expressions (e.g., escaping `${}` or `{{}}`).
  - Use of secure template engines or libraries that automatically escape template variables or input data to prevent injection.
  - Explicit validation or filtering of user input before rendering it into templates, ensuring that dangerous characters are disallowed.
  - Restrictions on the use of dynamic code execution in the template engine (e.g., disabling `eval()` or similar functions).
- Evidence suggesting vulnerability:
  - User input is directly inserted into template expressions without escaping or validation, allowing template injection (e.g., `${userInput}` or `{{maliciousInput}}`).
  - Template syntax (e.g., `${}`, `{{}}`) is not properly handled or neutralized before being processed by the template engine.
  - Template engines that allow untrusted or dynamically-generated content to be executed as code (e.g., allowing arbitrary script execution in templates).
  - No consistent or global input sanitization, allowing some templates to process untrusted input as part of the template logic.

How to use this guideline under incomplete context
- Identify where user input is incorporated into templates:
  - Where does the code inject external input into templates? Is the input being properly escaped or sanitized?
- Identify the template engine and its security features:
  - Is the template engine being used capable of safely handling input data (e.g., auto-escaping variables, disallowing dangerous constructs)?
- Generate a small number of targeted hypotheses:
  - H1: User input is directly injected into template expressions without proper escaping or neutralization, leading to potential code injection.
  - H2: The template engine allows dangerous or untrusted code execution as part of the template rendering process.
  - H3: Input validation or sanitization is inconsistently applied across templates, leaving some vulnerable to template injection.
  - H4: Dangerous template constructs (e.g., `${}`, `{{}}`) are allowed in user input, and there is no filtering or escaping mechanism in place.
- For each hypothesis, specify:
  (a) evidence in the snippet supporting it (e.g., direct input insertion into templates, unsafe template engine usage),
  (b) evidence needed to confirm it (e.g., escaping functions, validation checks),
  (c) counter-evidence that would refute it (e.g., auto-escaping, explicit input filtering).

Quick red flags in partial code (weak → strong)
- Strong: User input is directly injected into template expressions without escaping or sanitization, allowing the execution of arbitrary code.
- Medium: Input is inserted into templates, but no escaping or filtering is performed, leaving the possibility for template injection.
- Medium: Template engine allows dynamic execution or evaluation of input, making it vulnerable to injection attacks.
- Weak: Template input sanitization is handled by external libraries or frameworks not visible in the snippet → treat as Unknown and reduce confidence.
"""
if __name__ == "__main__":
    print(CWE_1336_RULE)
