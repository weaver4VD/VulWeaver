CWE_668_RULE = """
[CWE-668 Reference Guideline | Exposure of Resource to Wrong Sphere | Non-binding, Evidence-first]

Overview
- CWE-668 occurs when a system exposes a resource to an inappropriate or unintended control sphere, granting unauthorized access to actors or systems that should not have access.
- This vulnerability can lead to security breaches, as sensitive data or functionality becomes accessible to malicious users or systems, potentially leading to unauthorized access, data leakage, or misuse of critical resources.
- In partial snippets, missing or incomplete access control mechanisms are not proof of vulnerability. Use this guideline to form hypotheses and identify code evidence that would confirm or refute them.

What counts as "resource exposure" and "wrong sphere" (static analysis framing)
- Resource Exposure:
  - Making a system resource (e.g., data, API, file, database, or service) accessible to entities or users who should not have access to it.
- Wrong Sphere:
  - Allowing a resource intended for one context or user group (e.g., administrative data, internal services) to be accessible in another context or to unauthorized users (e.g., external users, low-privileged accounts).
  - Misconfigurations in security policies, access control, or network settings can result in a resource being exposed to the wrong control sphere.
  
Where exposure to the wrong sphere typically occurs (sensitive sinks)
- API or service misconfigurations:
  - APIs or services intended for internal or privileged use are exposed to external or unauthorized actors (e.g., public API endpoints with sensitive data).
- File and resource access:
  - Sensitive files or directories are accessible to users or systems that should not have access (e.g., public directories containing configuration files or logs).
- Network or protocol settings:
  - Network services intended for internal use are exposed to external networks (e.g., database servers, administrative interfaces accessible from the internet).
- Authorization or access control flaws:
  - Misconfigured access controls or roles that grant unauthorized users access to sensitive resources or actions (e.g., improper role-based access control settings).

Common failure modes (reasoning hints, not assumptions)
- Insufficient access control:
  - Resources are accessible without proper authorization checks (e.g., sensitive data exposed to all users, APIs accessible without authentication).
- Misconfigured public-facing services:
  - Internal or private services are unintentionally exposed to the internet, making them vulnerable to external access.
- Overly permissive permissions:
  - Excessive permissions are granted to resources, allowing unintended access to sensitive data or functionality.
- Inconsistent access controls across resources:
  - Some resources are properly protected, while others are exposed due to inconsistent security configurations or improper role assignment.

What “secure resource exposure and access control” looks like (context-specific)
- Strict access control and authorization:
  - Resources are only accessible by authorized users, services, or systems, with appropriate access control mechanisms such as authentication, role-based access control (RBAC), or attribute-based access control (ABAC).
- Network segmentation:
  - Ensure that sensitive resources are isolated from external networks and are only accessible through secure internal networks or VPNs.
- Service configuration:
  - Public-facing services should only expose non-sensitive resources, and any internal or administrative services should be tightly controlled and not accessible from the outside.
- Least privilege access:
  - Ensure that users or systems only have access to the minimum resources necessary for their function, reducing the risk of unauthorized access.
- Regular access audits:
  - Periodically review access control settings and resource visibility to ensure that sensitive resources are not exposed to unintended or unauthorized actors.

Common weak/insufficient defenses (signals of possible risk)
- Exposed sensitive data or functionality:
  - Sensitive files, databases, or APIs are accessible to unauthorized or unintended actors (e.g., public-facing file servers with internal config files).
- Lack of role-based access control:
  - Resources are not properly segmented by role, allowing users or systems with limited permissions to access sensitive data or perform restricted actions.
- Misconfigured network services:
  - Network services intended for internal use are inadvertently exposed to the internet, such as leaving an admin interface accessible externally.
- Improper authorization checks:
  - Authorization or access control mechanisms that do not correctly enforce user or system permissions, allowing unauthorized access to resources.

Evidence to look for in code (static snippet oriented)
- Strong evidence of mitigation:
  - Explicit access control checks that validate the identity and permissions of users or systems before granting access to resources.
  - Use of firewall or network segmentation to ensure sensitive services and resources are not exposed to unauthorized external networks.
  - Service configuration that restricts access to sensitive resources (e.g., internal-only APIs or services not exposed to public networks).
  - Secure role-based or attribute-based access control policies that ensure users or systems can only access the resources they are authorized to.
- Evidence suggesting vulnerability:
  - Sensitive resources or APIs are accessible without authentication or proper authorization checks.
  - Internal services, databases, or files are exposed to external access without proper security controls.
  - Excessive permissions granted to sensitive resources, allowing unintended users or systems to access them.
  - No network isolation or segmentation between internal and external services, making sensitive resources accessible from the internet.

How to use this guideline under incomplete context
- Identify where resources are exposed and accessed:
  - What resources are accessible, and who has access to them? Are sensitive resources exposed to external networks or unauthorized users?
- Identify access control mechanisms:
  - Are there authentication, authorization, and access control mechanisms in place to ensure only authorized users or systems can access sensitive resources?
- Generate a small number of targeted hypotheses:
  - H1: Sensitive resources are accessible due to improper or missing access control mechanisms.
  - H2: Internal services or resources are exposed to external networks or unauthorized users.
  - H3: Access control policies are inconsistently applied, allowing unauthorized access to some resources.
  - H4: Resource exposure is caused by misconfigurations in network services or access control settings.
- For each hypothesis, specify:
  (a) evidence in the snippet supporting it (e.g., access control checks, public URLs, network settings),
  (b) evidence needed to confirm it (secure service configurations, access control policies, network isolation),
  (c) counter-evidence that would refute it (properly segmented services, restricted access to resources).

Quick red flags in partial code (weak → strong)
- Strong: Sensitive resources or services are publicly exposed without proper access control or network isolation.
- Medium: Resources are accessible by unauthorized users due to missing or insufficient access control mechanisms.
- Medium: Network services or internal resources are misconfigured and inadvertently exposed to the public.
- Weak: Access control may be handled in external libraries or frameworks not visible in the current snippet → treat as Unknown and reduce confidence.
"""
if __name__ == "__main__":
    print(CWE_668_RULE)
