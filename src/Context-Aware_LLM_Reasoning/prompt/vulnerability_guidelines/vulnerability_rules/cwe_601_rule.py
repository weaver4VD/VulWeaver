CWE_601_RULE = """
[CWE-601 Reference Guideline | URL Redirection to Untrusted Site ('Open Redirect') | Non-binding, Evidence-first]

Overview
- CWE-601 occurs when a web application accepts user-controlled input specifying a link to an external site and uses that link for a redirect, without validating or properly sanitizing the destination URL.
- This vulnerability can allow attackers to redirect users to malicious websites, which can lead to phishing attacks, malware infections, or unauthorized actions, all by exploiting the redirection logic in the application.
- In partial snippets, missing input validation or unsafe redirection logic is not proof of vulnerability. Use this guideline to form hypotheses and identify code evidence that would confirm or refute them.

What counts as “URL redirection” and “untrusted sites” (static analysis framing)
- URL Redirection:
  - A process where the server sends an HTTP redirect response to the client, instructing the client to visit a different URL. This URL is typically provided as input from the user or external source (e.g., query parameters, form inputs).
- Untrusted sites:
  - External websites that are not under the application's control and may not be safe for users. These sites could host malicious content or be part of a phishing scheme to steal sensitive information.

Where open redirect issues typically occur (sensitive sinks)
- Web server redirects:
  - HTTP redirections (e.g., `HTTP 3xx` responses) based on URL parameters or other user inputs.
- Query parameters used in redirection:
  - URL parameters like `redirect_uri`, `next`, `destination`, `url`, or other generic names that allow user control over the redirect target.
- Authentication and authorization flows:
  - Redirects after successful login or authentication, where user-controlled input specifies where the user should be sent.

Common failure modes (reasoning hints, not assumptions)
- No validation on redirect URL:
  - Accepting user input that specifies a redirect destination without checking whether the URL is part of the trusted domain.
- No restrictions on external sites:
  - Allowing the redirection to any arbitrary external site, including untrusted or potentially malicious URLs.
- Overly permissive redirect parameters:
  - Accepting and using common URL parameters (e.g., `redirect_uri`) without checking for safe destinations.
- Inconsistent redirect handling:
  - Allowing redirects only in certain cases but not validating the URL properly in other cases, leading to inconsistent behavior.

What “secure URL redirection” looks like (context-specific)
- Validate and sanitize user input:
  - Always validate that the redirect URL belongs to a trusted domain before performing the redirection. Reject or sanitize any untrusted or unexpected URLs.
- Restrict redirection destinations:
  - Only allow redirects to trusted URLs that are predefined or controlled by the application (e.g., redirect only to URLs within the same domain or a whitelist of allowed external domains).
- Use relative URLs or tokens:
  - Whenever possible, use relative URLs or tokens to represent destination pages within the application, instead of accepting full URLs that could lead to external sites.
- Provide feedback or warnings for redirects:
  - If the user is being redirected to an external site, provide a warning message that informs them of the action.
- URL encoding and sanitization:
  - Ensure that any URLs provided by the user are properly encoded and do not contain unexpected characters that could exploit redirection mechanisms.

Common weak/insufficient defenses (signals of possible risk)
- Trusting user input without validation:
  - Directly using a user-supplied URL for redirection without verifying whether the URL is part of a trusted domain.
- Using unsafe URL parameters:
  - Accepting generic parameters (e.g., `url`, `next`, `destination`) and using them without any checks or restrictions.
- Lack of domain validation:
  - Allowing redirection to any external site, potentially leading to malicious redirects to untrusted domains.
- Failure to handle edge cases:
  - Allowing redirects to URLs with special characters or unexpected formatting that could bypass validation.

Evidence to look for in code (static snippet oriented)
- Strong evidence of mitigation:
  - URL validation is performed to ensure the destination is part of a trusted domain, and untrusted URLs are rejected or sanitized.
  - A whitelist of allowed redirect URLs is enforced, ensuring that users can only be redirected to pre-approved locations.
  - Use of relative URLs or tokens instead of full user-supplied URLs to prevent open redirects.
- Evidence suggesting vulnerability:
  - A redirect URL is directly taken from user input (e.g., from query parameters or form fields) without validation or filtering.
  - Redirection to external sites is allowed, and no checks are performed on the destination domain.
  - The application accepts open URL parameters such as `redirect_uri`, `next`, or `destination` without verifying the value before redirection.

How to use this guideline under incomplete context
- Identify where URL redirection occurs:
  - Look for places where user input is used to construct or influence a URL for redirection (e.g., `redirect_uri`, `next`, `url` parameters).
- Identify the validation and sanitization process:
  - Are there checks to ensure the redirection URL is part of a trusted domain or properly sanitized? How are untrusted URLs handled?
- Generate a small number of targeted hypotheses:
  - H1: User input is used for redirection without validation or domain checking.
  - H2: Redirection is allowed to any external site without any filtering or validation.
  - H3: Proper validation exists but is not applied consistently across all redirection paths.
  - H4: Redirection logic is implemented in external libraries or helpers that are not visible in the current snippet.
- For each hypothesis, specify:
  (a) evidence in the snippet supporting it (use of user input in redirection, lack of validation, untrusted URL handling),
  (b) evidence needed to confirm it (validation logic, URL sanitization checks, trusted domain lists),
  (c) counter-evidence that would refute it (explicit domain validation, secure redirection practices, whitelisted URLs).

Quick red flags in partial code (weak → strong)
- Strong: user-controlled input is directly used in redirection (`redirect_uri`, `destination`, etc.) with no validation.
- Medium: URL validation exists but only checks for basic formats (e.g., checking if the input is a valid URL) without domain restrictions.
- Medium: redirection occurs, but the application allows external site redirection without any checks for trusted domains.
- Weak: redirection logic may be handled outside of the shown code (e.g., in frameworks or external modules) → treat as Unknown and reduce confidence.
"""
if __name__ == "__main__":
    print(CWE_601_RULE)