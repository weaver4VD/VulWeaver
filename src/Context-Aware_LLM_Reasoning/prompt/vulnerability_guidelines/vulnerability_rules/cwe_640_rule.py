CWE_640_RULE = """
[CWE-640 Reference Guideline | Weak Password Recovery Mechanism for Forgotten Password | Non-binding, Evidence-first]

Overview
- CWE-640 occurs when a product provides a mechanism for users to recover or change their passwords without knowing the original password, but the mechanism is weak, allowing attackers to bypass authentication and gain unauthorized access.
- Weak password recovery mechanisms, such as insecure security questions or easily guessable verification methods, can be exploited by attackers to gain control of user accounts without needing the original password.
- In partial snippets, missing or inadequate recovery mechanisms are not proof of vulnerability. Use this guideline to form hypotheses and identify code evidence that would confirm or refute them.

What counts as a “weak password recovery mechanism” (static analysis framing)
- Weakness in the recovery process:
  - Using easily guessable or static answers for security questions (e.g., mother's maiden name, pet's name).
  - Recovery mechanisms that rely on easily accessible or public data for authentication.
  - Failure to validate the identity of the user effectively during the password recovery process.
- Insufficient or flawed multi-factor authentication (MFA):
  - Not requiring a secondary factor (e.g., email or SMS verification) or using weak MFA mechanisms (e.g., SMS-based tokens vulnerable to SIM swapping).
- Weak link or token validation:
  - Sending password recovery links or tokens that are not time-limited or easily guessable, allowing attackers to reuse old recovery links.
- Insufficient account lockout or rate-limiting mechanisms:
  - Allowing unlimited attempts to guess answers to security questions or reuse recovery tokens, enabling brute-force attacks.

Where weak password recovery mechanisms typically occur (sensitive sinks)
- Password recovery flows:
  - Any user flow for resetting or recovering forgotten passwords, including sending recovery tokens via email/SMS, answering security questions, or verifying account ownership.
- Account authentication:
  - Mechanisms that verify user identity during password reset or recovery (e.g., security question answers, email verification, or one-time links).
- Multi-factor authentication (MFA) in recovery process:
  - If MFA is part of the password recovery process, weak or misconfigured MFA systems may leave users vulnerable.

Common failure modes (reasoning hints, not assumptions)
- Weak or guessable security questions:
  - Using security questions with easily discoverable answers, such as “What is your pet’s name?” or “Where did you go to high school?”.
- Insufficient validation of recovery tokens:
  - Recovery links or tokens are not validated properly, such as having no expiration time, being easily guessed, or being reused.
- Lack of multi-factor authentication:
  - Allowing password recovery via just one factor (e.g., email) without a second layer of verification (e.g., SMS or authenticator app).
- Inadequate account lockout or rate limiting:
  - Allowing attackers to perform unlimited recovery attempts or use brute-force tactics to guess recovery tokens or answers to security questions.

What “strong password recovery mechanism” looks like (context-specific)
- Use secure, dynamic methods for password recovery:
  - Use one-time, time-limited password reset tokens or links that are difficult to guess and expire after a short period.
  - Require multi-factor authentication (MFA) during the recovery process (e.g., email or SMS verification in addition to answering security questions).
- Use hard-to-guess and non-reversible security questions:
  - Implement security questions that cannot easily be guessed or found through social engineering (e.g., avoid using publicly available information).
  - Alternatively, do not rely on security questions at all, and use more secure recovery methods (e.g., email/SMS verification).
- Prevent brute-force attacks:
  - Implement account lockout or rate-limiting mechanisms that prevent attackers from guessing security question answers or repeatedly attempting to use old recovery links.
- Secure token management:
  - Ensure that password recovery tokens or links are unique, time-limited, and one-time use only. Invalidating expired or used recovery tokens is a good practice.

Common weak/insufficient defenses (signals of possible risk)
- Predictable security questions or answers:
  - Using weak, easily guessable security questions like “What is your mother’s maiden name?” or “What is your favorite color?”.
- Lack of multi-factor authentication:
  - Only relying on a single factor (e.g., email verification) for password recovery, leaving users vulnerable to attackers gaining access through social engineering.
- Unprotected recovery tokens:
  - Sending password reset links or tokens without expiration or reuse prevention, making them vulnerable to replay attacks or guessing.
- No account lockout or rate-limiting:
  - Allowing attackers to brute-force or try many variations of answers to security questions or recovery tokens without restrictions.

Evidence to look for in code (static snippet oriented)
- Strong evidence of mitigation:
  - The use of secure, one-time recovery links or tokens that expire after a short time (e.g., `reset_token` with expiration check).
  - Multi-factor authentication (MFA) during the password recovery process (e.g., verifying through both email and SMS).
  - Secure handling of security questions (e.g., not using easily guessable questions, using random questions with answers that are not easily accessible).
  - Rate-limiting or account lockout mechanisms during password recovery attempts to mitigate brute-force attacks.
- Evidence suggesting vulnerability:
  - Password recovery tokens that do not expire or are predictable (e.g., a URL with a simple parameter like `token=12345`).
  - Password recovery requiring only easily guessable security questions, or no additional factors such as MFA.
  - No evidence of token validation (e.g., reuse of expired tokens, no expiration check).
  - No restrictions on the number of attempts for password recovery, allowing for brute-force attacks.

How to use this guideline under incomplete context
- Identify the password recovery mechanism:
  - What method is used for password recovery (e.g., email reset link, security questions, SMS-based recovery)?
- Identify security and validation controls:
  - Is multi-factor authentication used in the recovery process? Are there checks for token expiration or usage limits?
- Generate a small number of targeted hypotheses:
  - H1: Password recovery relies on weak security questions or one-factor authentication.
  - H2: Recovery links or tokens are not validated, expired, or one-time-use only.
  - H3: Recovery mechanisms are protected with MFA, token expiration, and are not vulnerable to brute-force attempts.
  - H4: Password recovery logic is handled by external libraries or frameworks that may not apply strong security measures (e.g., social login providers).
- For each hypothesis, specify:
  (a) evidence in the snippet supporting it (use of simple recovery questions, weak token validation),
  (b) evidence needed to confirm it (MFA enforcement, token validation, expiration checks),
  (c) counter-evidence that would refute it (strong token management, use of dynamic recovery tokens with expiration).

Quick red flags in partial code (weak → strong)
- Strong: recovery links or tokens can be easily guessed or reused (e.g., predictable tokens, no expiration).
- Medium: password recovery relies only on one factor, such as email, with no additional verification or protection.
- Medium: weak or easily guessable security questions used in the recovery process (e.g., mother’s maiden name).
- Weak: recovery is managed by external libraries or frameworks with unknown or weak security practices → treat as Unknown and reduce confidence.
"""
if __name__ == "__main__":
    print(CWE_640_RULE)
