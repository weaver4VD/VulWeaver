CWE_611_RULE = """
[CWE-611 Reference Guideline | Improper Restriction of XML External Entity Reference (XXE) | Non-binding, Evidence-first]

Overview
- CWE-611 occurs when an application processes XML input containing an external entity reference, and the XML parser is misconfigured, allowing an attacker to inject malicious content, access internal files, perform denial-of-service (DoS) attacks, or exploit system resources.
- The vulnerability arises from improper handling of XML external entity (XXE) references, which can lead to unauthorized access to files, system resources, or arbitrary code execution.
- In partial snippets, missing or incomplete input validation, or improper parser configuration is not proof of vulnerability. Use this guideline to form hypotheses and identify code evidence that would confirm or refute them.

What counts as “XML External Entity (XXE) Reference” (static analysis framing)
- XML External Entity (XXE):
  - A feature of XML parsers that allows references to external resources (e.g., files, URLs) to be included inside an XML document. These references can be used to inject malicious content or access sensitive files.
- External entities:
  - External files, network resources, or other references included in an XML document using `<!ENTITY>` or `<!DOCTYPE>` declarations.
- Misconfiguration:
  - When XML parsers do not properly restrict or sanitize external entity resolution, allowing attackers to craft XML payloads that reference sensitive resources or cause harmful operations.

Where XXE vulnerabilities typically arise (sensitive sinks)
- XML parsing:
  - Functions or libraries that parse XML documents (`DocumentBuilder`, `SAXParser`, `XMLParser`, etc.).
- Data sources:
  - Accepting and processing user-supplied XML data from untrusted sources, such as uploaded files, API requests, or external services.
- External entity declarations:
  - XML documents with external entity declarations or references that are processed by the application without restrictions.

Common failure modes (reasoning hints, not assumptions)
- Improper parser configuration:
  - XML parsers that are not configured to disable external entity resolution (e.g., enabling `EntityResolver`, `resolveEntity` or similar configuration settings).
- Untrusted XML data:
  - Allowing user-supplied XML data to contain external entity references that are not properly sanitized or validated.
- Missing entity validation:
  - Not validating or sanitizing external entity references before processing them, potentially allowing attackers to inject malicious content.
- Failure to limit entity resolution:
  - Failure to apply security policies such as preventing file access via external entities, leading to potential information disclosure or resource exhaustion.

What “secure XML parsing” looks like (context-specific)
- Disable external entity resolution:
  - Disable the ability to resolve external entities in the XML parser configuration (`setFeature("http://apache.org/xml/features/disallow-doctype-decl", true)` or equivalent).
- Use secure parsers:
  - Use modern XML parsers with built-in protections against XXE (e.g., `XMLInputFactory.newFactory()` in Java with features like `FEATURE_SECURE_PROCESSING` enabled).
- Validate XML input:
  - Apply strict validation of XML data sources, ensuring that they do not contain untrusted external entity references.
- Limit the scope of external entities:
  - If external entities must be used, limit their scope to trusted resources and ensure they do not access sensitive files or services.
- Apply security patches:
  - Keep XML libraries and parsers updated with the latest security patches to prevent known XXE vulnerabilities.

Common weak/insufficient defenses (signals of possible risk)
- Not disabling external entity resolution:
  - XML parsers configured to resolve external entities, potentially allowing access to internal files or system resources.
- Processing untrusted XML data:
  - Allowing user-controlled XML documents to be parsed without validating or sanitizing external entity references.
- Inconsistent parser configuration:
  - Misconfigured XML parsers that do not enforce secure processing features or improperly allow external entity resolution.
- No file or resource access restrictions:
  - Failing to restrict what external entities can access, allowing arbitrary file system access or external network requests.

Evidence to look for in code (static snippet oriented)
- Strong evidence of mitigation:
  - XML parser configuration explicitly disables external entity resolution (e.g., `setFeature("http://apache.org/xml/features/disallow-doctype-decl", true)`).
  - Use of secure XML parsing libraries or frameworks that prevent XXE attacks by default.
  - Input validation mechanisms in place that sanitize or reject untrusted XML data before processing.
- Evidence suggesting vulnerability:
  - External entity references allowed in XML input without restrictions or validation.
  - XML parsers configured to resolve external entities, potentially allowing access to sensitive files or resources.
  - No explicit security settings in place to restrict external entity resolution in XML parsers.

How to use this guideline under incomplete context
- Identify the XML parser and configuration:
  - Is the XML parser configured to resolve external entities? Are external entity references explicitly disabled?
- Identify the data sources and trust levels:
  - Where does the XML data come from? Is it untrusted user input or external service data that could contain malicious XML payloads?
- Generate a small number of targeted hypotheses:
  - H1: External entity references are allowed in the XML parser configuration, making it vulnerable to XXE.
  - H2: XML data is processed without validation or sanitization, allowing untrusted content to be parsed.
  - H3: XXE mitigation is in place but not visible in this snippet (e.g., handled by a global parser configuration).
  - H4: Input validation exists but is not consistently applied to XML data.
- For each hypothesis, specify:
  (a) evidence in the snippet supporting it (use of XML parser, configuration settings, data source handling),
  (b) evidence needed to confirm it (parser configuration, external entity handling, input validation),
  (c) counter-evidence that would refute it (secure parser settings, input sanitization, no external entity references).

Quick red flags in partial code (weak → strong)
- Strong: XML parsing with external entity references enabled or no clear restriction on entity resolution.
- Medium: XML data processed with no apparent input validation or sanitization.
- Medium: XML parsers that do not explicitly disable external entity resolution or do not use secure processing features.
- Weak: Security-related configuration may be handled externally or in libraries not shown → treat as Unknown and reduce confidence.
"""
if __name__ == "__main__":
    print(CWE_611_RULE)
