CWE_804_RULE = """
[CWE-804 Reference Guideline | Guessable CAPTCHA | Non-binding, Evidence-first]

Overview
- CWE-804 occurs when a product uses a CAPTCHA challenge that can be easily guessed or automatically recognized by a non-human actor, such as a bot or automated system.
- This vulnerability can allow attackers to bypass the CAPTCHA and gain unauthorized access to services, submit forms, or perform other actions that are meant to be restricted to human users, undermining the intended security controls.
- In partial snippets, missing or weak CAPTCHA configurations are not proof of vulnerability. Use this guideline to form hypotheses and identify code evidence that would confirm or refute them.

What counts as "guessable CAPTCHA" (static analysis framing)
- CAPTCHA:
  - A test designed to determine whether the user is a human or a bot. Typically, CAPTCHA challenges involve reading distorted text, recognizing images, or completing simple puzzles that are difficult for automated systems to solve.
- Guessable CAPTCHA:
  - A CAPTCHA challenge that can be easily bypassed or guessed by non-human actors, such as using simple or predictable patterns, weak randomization, or commonly used challenges.
  - Examples of guessable CAPTCHA include distorted text that is too simple to read, image challenges that have too few variations, or challenges that can be solved using OCR (Optical Character Recognition) or machine learning algorithms.

Where guessable CAPTCHA issues typically occur (sensitive sinks)
- Text-based CAPTCHA:
  - Challenges where distorted characters are presented to the user, but the distortion is too simple, or the characters are too easy to guess or recognize by OCR systems.
- Image-based CAPTCHA:
  - Challenges where users are asked to select specific images (e.g., "Select all images with cars"), but the images are too simple, or the challenge has too few variations to prevent automated recognition.
- Audio CAPTCHA:
  - Challenges that use audio to convey a string or set of instructions, but the audio quality is poor or too simple for automated systems to bypass.
- Custom CAPTCHA implementations:
  - In-house CAPTCHA systems or algorithms that do not apply strong randomness, encryption, or obfuscation, leading to predictable patterns or easily recognized content by bots.

Common failure modes (reasoning hints, not assumptions)
- Simple patterns:
  - Using distorted characters, images, or puzzles that follow predictable patterns, making it easier for automated systems to guess or recognize the content.
- Weak randomization:
  - The CAPTCHA is generated using weak or predictable randomization, such as fixed text pools, predictable distortion levels, or limited image variations.
- Inadequate challenge complexity:
  - The CAPTCHA challenge is too simple for human users or has limited complexity, making it easy for bots to bypass.
- Lack of anti-bot mechanisms:
  - The CAPTCHA system lacks any features or challenges that are specifically designed to detect and prevent automated recognition or attacks (e.g., rate-limiting, time-based checks).

What “strong CAPTCHA mechanisms” look like (context-specific)
- Use complex and varied challenges:
  - Ensure that CAPTCHA challenges involve complex, randomly generated text, images, or puzzles that are difficult for automated systems to solve. Use a diverse set of challenges to avoid repetitive patterns.
- Implement strong randomization:
  - Generate CAPTCHA content with strong, unpredictable randomization, including varied fonts, distortions, backgrounds, and image selections. Avoid predictable patterns.
- Ensure CAPTCHA difficulty:
  - Design CAPTCHA challenges that are easy for humans to solve but difficult for automated systems (e.g., challenging image recognition, audio CAPTCHA with varied accents or noises).
- Use modern CAPTCHA systems:
  - Implement advanced CAPTCHA technologies such as reCAPTCHA, which use behavioral analytics and machine learning to detect human interactions, as they are more resistant to automated solving techniques.
- Implement rate-limiting and time-based checks:
  - Protect CAPTCHA forms with rate-limiting mechanisms to prevent brute-force attacks by limiting the number of attempts that can be made within a given time period.

Common weak/insufficient defenses (signals of possible risk)
- Simple or predictable CAPTCHA patterns:
  - Using easily guessable or simple CAPTCHA challenges (e.g., simple distorted text with common words, too few image variations).
- Insufficient CAPTCHA complexity:
  - CAPTCHA challenges that are easy to solve or bypass by both humans and bots (e.g., low distortion, limited set of characters or images).
- Lack of CAPTCHA randomness:
  - Weak or predictable randomization techniques for CAPTCHA content generation, leading to easily recognized patterns.
- Inconsistent or outdated CAPTCHA technology:
  - Relying on outdated or poorly designed CAPTCHA mechanisms that do not incorporate the latest anti-bot techniques or do not properly randomize challenges.

Evidence to look for in code (static snippet oriented)
- Strong evidence of mitigation:
  - Complex and unpredictable CAPTCHA challenges that are difficult for bots to recognize, with strong randomization and complexity (e.g., varied fonts, random image selection, complex puzzles).
  - Use of modern CAPTCHA systems such as reCAPTCHA, hCaptcha, or similar technologies that incorporate behavioral analysis and advanced bot-detection mechanisms.
  - Implementation of rate-limiting or other anti-bot mechanisms that limit the number of CAPTCHA attempts from a single actor within a short time frame.
- Evidence suggesting vulnerability:
  - Simple or repetitive CAPTCHA challenges that follow predictable patterns, such as predictable text, limited image sets, or easily recognizable puzzles.
  - Weak randomization or low complexity in the CAPTCHA content (e.g., fixed distortions, limited variations in font and background).
  - Lack of anti-bot features such as rate-limiting, CAPTCHA retries, or additional checks to detect automated solving.

How to use this guideline under incomplete context
- Identify the CAPTCHA system in use:
  - Is the CAPTCHA challenge based on text, images, audio, or custom mechanisms? How complex is the challenge?
- Identify the randomization and complexity of the challenge:
  - Does the CAPTCHA use strong randomization techniques, such as varying text distortion, backgrounds, or character sets? How complex is the challenge?
- Generate a small number of targeted hypotheses:
  - H1: The CAPTCHA challenge is too simple or predictable, allowing bots to easily bypass it.
  - H2: Randomization is weak, making the CAPTCHA challenge guessable by automated systems.
  - H3: The CAPTCHA system does not use modern anti-bot technologies (e.g., reCAPTCHA or hCaptcha), making it vulnerable to bypass.
  - H4: CAPTCHA challenges are not well-designed or too easy for both bots and users to solve.
- For each hypothesis, specify:
  (a) evidence in the snippet supporting it (e.g., predictable CAPTCHA patterns, lack of randomization),
  (b) evidence needed to confirm it (e.g., complexity checks, modern CAPTCHA technology implementation),
  (c) counter-evidence that would refute it (e.g., strong randomization, use of advanced CAPTCHA systems).

Quick red flags in partial code (weak → strong)
- Strong: CAPTCHA challenges that follow predictable patterns or can be easily solved by automated systems (e.g., simple distorted text, limited image sets).
- Medium: CAPTCHA challenges are not complex enough, or randomization is weak, making them susceptible to automated solving techniques.
- Medium: No evidence of advanced anti-bot mechanisms or rate-limiting to prevent excessive CAPTCHA attempts.
- Weak: CAPTCHA handling is managed by external libraries or frameworks not visible in the snippet → treat as Unknown and reduce confidence.
"""
if __name__ == "__main__":
    print(CWE_804_RULE)