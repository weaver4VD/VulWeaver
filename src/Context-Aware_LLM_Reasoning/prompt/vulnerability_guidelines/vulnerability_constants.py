from __future__ import annotations

from enum import Enum
from typing import Optional

from .vulnerability_rules import get_rule


class CWEType(Enum):
    CWE_20 = "CWE-20"
    CWE_22 = "CWE-22"
    CWE_23 = "CWE-23"
    CWE_24 = "CWE-24"
    CWE_36 = "CWE-36"
    CWE_74 = "CWE-74"
    CWE_77 = "CWE-77"
    CWE_78 = "CWE-78"
    CWE_79 = "CWE-79"
    CWE_89 = "CWE-89"
    CWE_91 = "CWE-91"
    CWE_94 = "CWE-94"
    CWE_95 = "CWE-95"
    CWE_116 = "CWE-116"
    CWE_119 = "CWE-119"
    CWE_120 = "CWE-120"
    CWE_122 = "CWE-122"
    CWE_125 = "CWE-125"
    CWE_134 = "CWE-134"
    CWE_138 = "CWE-138"
    CWE_189 = "CWE-189"
    CWE_190 = "CWE-190"
    CWE_191 = "CWE-191"
    CWE_193 = "CWE-193"
    CWE_200 = "CWE-200"
    CWE_201 = "CWE-201"
    CWE_209 = "CWE-209"
    CWE_212 = "CWE-212"
    CWE_257 = "CWE-257"
    CWE_264 = "CWE-264"
    CWE_269 = "CWE-269"
    CWE_276 = "CWE-276"
    CWE_281 = "CWE-281"
    CWE_284 = "CWE-284"
    CWE_285 = "CWE-285"
    CWE_287 = "CWE-287"
    CWE_288 = "CWE-288"
    CWE_295 = "CWE-295"
    CWE_310 = "CWE-310"
    CWE_312 = "CWE-312"
    CWE_345 = "CWE-345"
    CWE_347 = "CWE-347"
    CWE_352 = "CWE-352"
    CWE_354 = "CWE-354"
    CWE_359 = "CWE-359"
    CWE_362 = "CWE-362"
    CWE_369 = "CWE-369"
    CWE_379 = "CWE-379"
    CWE_384 = "CWE-384"
    CWE_385 = "CWE-385"
    CWE_399 = "CWE-399"
    CWE_400 = "CWE-400"
    CWE_401 = "CWE-401"
    CWE_409 = "CWE-409"
    CWE_415 = "CWE-415"
    CWE_416 = "CWE-416"
    CWE_434 = "CWE-434"
    CWE_444 = "CWE-444"
    CWE_459 = "CWE-459"
    CWE_470 = "CWE-470"
    CWE_476 = "CWE-476"
    CWE_502 = "CWE-502"
    CWE_521 = "CWE-521"
    CWE_522 = "CWE-522"
    CWE_532 = "CWE-532"
    CWE_552 = "CWE-552"
    CWE_601 = "CWE-601"
    CWE_611 = "CWE-611"
    CWE_613 = "CWE-613"
    CWE_617 = "CWE-617"
    CWE_640 = "CWE-640"
    CWE_665 = "CWE-665"
    CWE_668 = "CWE-668"
    CWE_703 = "CWE-703"
    CWE_704 = "CWE-704"
    CWE_732 = "CWE-732"
    CWE_754 = "CWE-754"
    CWE_755 = "CWE-755"
    CWE_770 = "CWE-770"
    CWE_772 = "CWE-772"
    CWE_787 = "CWE-787"
    CWE_837 = "CWE-837"
    CWE_804 = "CWE-804"
    CWE_824 = "CWE-824"
    CWE_835 = "CWE-835"
    CWE_843 = "CWE-843"
    CWE_862 = "CWE-862"
    CWE_863 = "CWE-863"
    CWE_908 = "CWE-908"
    CWE_909 = "CWE-909"
    CWE_917 = "CWE-917"
    CWE_918 = "CWE-918"
    CWE_923 = "CWE-923"
    CWE_1018 = "CWE-1018"
    CWE_1333 = "CWE-1333"
    CWE_1336 = "CWE-1336"


CWE_NAME_MAP = {
    CWEType.CWE_20.value: "CWE-20: Improper Input Validation",
    CWEType.CWE_22.value: "CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')",
    CWEType.CWE_23.value: "CWE-23: Relative Path Traversal",
    CWEType.CWE_24.value: "CWE-24: Path Traversal: '../' Sequences",
    CWEType.CWE_36.value: "CWE-36: Absolute Path Traversal",
    CWEType.CWE_74.value: "CWE-74: Improper Neutralization of Special Elements in Output Used by a Downstream Component ('Injection')",
    CWEType.CWE_77.value: "CWE-77: Improper Neutralization of Special Elements used in a Command ('Command Injection')",
    CWEType.CWE_78.value: "CWE-78: Improper Neutralization of Special Elements used in an OS Command ('OS Command Injection')",
    CWEType.CWE_79.value: "CWE-79: Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')",
    CWEType.CWE_89.value: "CWE-89: Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')",
    CWEType.CWE_91.value: "CWE-91: XML Injection (aka Blind XPath Injection)",
    CWEType.CWE_94.value: "CWE-94: Improper Control of Generation of Code ('Code Injection')",
    CWEType.CWE_95.value: "CWE-95: Dynamic Evaluation Injection (Eval Injection)",
    CWEType.CWE_116.value: "CWE-116: Improper Encoding or Escaping of Output",
    CWEType.CWE_119.value: "CWE-119: Improper Restriction of Operations within the Bounds of a Memory Buffer",
    CWEType.CWE_120.value: "CWE-120: Buffer Copy without Checking Size of Input ('Classic Buffer Overflow')",
    CWEType.CWE_122.value: "CWE-122: Heap-based Buffer Overflow",
    CWEType.CWE_125.value: "CWE-125: Out-of-bounds Read",
    CWEType.CWE_134.value: "CWE-134: Use of Externally-Controlled Format String",
    CWEType.CWE_138.value: "CWE-138: Improper Neutralization of Special Elements (Generic Control/Syntax Markers)",
    CWEType.CWE_189.value: "CWE-189: Numeric Errors (Category)",
    CWEType.CWE_190.value: "CWE-190: Integer Overflow or Wraparound",
    CWEType.CWE_191.value: "CWE-191: Integer Underflow (Wrap or Wraparound)",
    CWEType.CWE_193.value: "CWE-193: Off-by-one Error",
    CWEType.CWE_200.value: "CWE-200: Exposure of Sensitive Information to an Unauthorized Actor",
    CWEType.CWE_201.value: "CWE-201: Insertion of Sensitive Information Into Sent Data",
    CWEType.CWE_209.value: "CWE-209: Error Message Contains Sensitive Information",
    CWEType.CWE_212.value: "CWE-212: Improper Removal of Sensitive Information Before Storage or Transfer",
    CWEType.CWE_257.value: "CWE-257: Storing Passwords in a Recoverable Format",
    CWEType.CWE_264.value: "CWE-264: CWE CATEGORY: Permissions, Privileges, and Access Controls",
    CWEType.CWE_269.value: "CWE-269: Improper Privilege Management",
    CWEType.CWE_276.value: "CWE-276: Incorrect Default Permissions",
    CWEType.CWE_281.value: "CWE-281: Improper Preservation of Permissions",
    CWEType.CWE_284.value: "CWE-284: Improper Access Control",
    CWEType.CWE_285.value: "CWE-285: Improper Authorization",
    CWEType.CWE_287.value: "CWE-287: Improper Authentication",
    CWEType.CWE_288.value: "CWE-288: Authentication Bypass Using an Alternate Path or Channel",
    CWEType.CWE_295.value: "CWE-295: Improper Certificate Validation",
    CWEType.CWE_310.value: "CWE-310: CWE CATEGORY: Cryptographic Issues",
    CWEType.CWE_312.value: "CWE-312: Cleartext Storage of Sensitive Information",
    CWEType.CWE_345.value: "CWE-345: Insufficient Verification of Data Authenticity",
    CWEType.CWE_347.value: "CWE-347: Improper Verification of Cryptographic Signature",
    CWEType.CWE_352.value: "CWE-352: Cross-Site Request Forgery (CSRF)",
    CWEType.CWE_354.value: "CWE-354: Improper Validation of Integrity Check Value",
    CWEType.CWE_359.value: "CWE-359: Exposure of Private Personal Information",
    CWEType.CWE_362.value: "CWE-362: Race Condition (Improper Synchronization on Shared Resource)",
    CWEType.CWE_369.value: "CWE-369: Divide By Zero",
    CWEType.CWE_379.value: "CWE-379: Creation of Temporary File in Directory with Insecure Permissions",
    CWEType.CWE_384.value: "CWE-384: Session Fixation",
    CWEType.CWE_385.value: "CWE-385: Covert Timing Channel",
    CWEType.CWE_399.value: "CWE-399: Resource Management Errors (Category)",
    CWEType.CWE_400.value: "CWE-400: Uncontrolled Resource Consumption",
    CWEType.CWE_401.value: "CWE-401: Missing Release of Memory after Effective Lifetime",
    CWEType.CWE_409.value: "CWE-409: Improper Handling of Highly Compressed Data (Data Amplification)",
    CWEType.CWE_415.value: "CWE-415: Double Free",
    CWEType.CWE_416.value: "CWE-416: Use After Free",
    CWEType.CWE_434.value: "CWE-434: Unrestricted Upload of File with Dangerous Type",
    CWEType.CWE_444.value: "CWE-444: Inconsistent Interpretation of HTTP Requests (Request/Response Smuggling)",
    CWEType.CWE_459.value: "CWE-459: Incomplete Cleanup",
    CWEType.CWE_470.value: "CWE-470: Use of Externally-Controlled Input to Select Classes or Code ('Unsafe Reflection')",
    CWEType.CWE_476.value: "CWE-476: NULL Pointer Dereference",
    CWEType.CWE_502.value: "CWE-502: Deserialization of Untrusted Data",
    CWEType.CWE_521.value: "CWE-521: Weak Password Requirements",
    CWEType.CWE_522.value: "CWE-522: Insufficiently Protected Credentials",
    CWEType.CWE_532.value: "CWE-532: Insertion of Sensitive Information into Log File",
    CWEType.CWE_552.value: "CWE-552: Files or Directories Accessible to External Parties",
    CWEType.CWE_601.value: "CWE-601: URL Redirection to Untrusted Site ('Open Redirect')",
    CWEType.CWE_611.value: "CWE-611: Improper Restriction of XML External Entity Reference",
    CWEType.CWE_613.value: "CWE-613: Insufficient Session Expiration",
    CWEType.CWE_617.value: "CWE-617: Reachable Assertion",
    CWEType.CWE_640.value: "CWE-640: Weak Password Recovery Mechanism for Forgotten Password",
    CWEType.CWE_665.value: "CWE-665: Improper Initialization",
    CWEType.CWE_668.value: "CWE-668: Exposure of Resource to Wrong Sphere",
    CWEType.CWE_703.value: "CWE-703: Improper Check or Handling of Exceptional Conditions",
    CWEType.CWE_704.value: "CWE-704: Incorrect Type Conversion or Cast",
    CWEType.CWE_732.value: "CWE-732: Incorrect Permission Assignment for Critical Resource",
    CWEType.CWE_754.value: "CWE-754: Improper Check for Unusual or Exceptional Conditions",
    CWEType.CWE_755.value: "CWE-755: Improper Handling of Exceptional Conditions",
    CWEType.CWE_770.value: "CWE-770: Allocation of Resources Without Limits or Throttling",
    CWEType.CWE_772.value: "CWE-772: Missing Release of Resource after Effective Lifetime",
    CWEType.CWE_787.value: "CWE-787: Out-of-bounds Write",
    CWEType.CWE_804.value: "CWE-804: Guessable CAPTCHA",
    CWEType.CWE_824.value: "CWE-824: Access of Uninitialized Pointer",
    CWEType.CWE_835.value: "CWE-835: Loop with Unreachable Exit Condition ('Infinite Loop')",
    CWEType.CWE_837.value: "CWE-837: Improper Enforcement of a Single, Unique Action",
    CWEType.CWE_843.value: "CWE-843: Access of Resource Using Incompatible Type ('Type Confusion')",
    CWEType.CWE_862.value: "CWE-862: Missing Authorization",
    CWEType.CWE_863.value: "CWE-863: Incorrect Authorization",
    CWEType.CWE_908.value: "CWE-908: Use of Uninitialized Resource",
    CWEType.CWE_909.value: "CWE-909: Missing Initialization of Resource",
    CWEType.CWE_917.value: "CWE-917: Improper Neutralization of Special Elements used in an Expression Language Statement ('Expression Language Injection')",
    CWEType.CWE_918.value: "CWE-918: Server-Side Request Forgery (SSRF)",
    CWEType.CWE_923.value: "CWE-923: Improper Restriction of Communication Channel to Intended Endpoints",
    CWEType.CWE_1018.value: "CWE-1018: CWE CATEGORY: Manage User Sessions",
    CWEType.CWE_1333.value: "CWE-1333: Inefficient Regular Expression Complexity",
    CWEType.CWE_1336.value: "CWE-1336: Improper Neutralization of Special Elements Used in a Template Engine",
}

class _LazyCWERuleMap:
    """
    Lazy rule map that mimics the dict `.get()` API used by callers.
    """

    def get(self, cwe: str, default: str = "no rules") -> str:
        rule: Optional[str] = get_rule(cwe)
        return rule if rule is not None else default


VULN_RULES = _LazyCWERuleMap()
CWE_GUIDELINE_MAP = VULN_RULES
